<!DOCTYPE html>
<html>

<head>
  <title>Friend list</title>
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <h1 class="h1left">Friends</h1>
  <div class="navbar">
    <!-- &lt is the sign for the "<" -> span changes the inline styling without 
            changing the representation of the, in this case, link
            &gt stands for ">" -->

    <a href="logout.html"> <span>&lt; Logout</span></a> |

    <!-- The pipe character is seprating the two links -->

    <a href="settings.html"> Settings</a>
  </div>

  <!-- hr is rendering a seperator line -->

  <hr />

  <div class="chatfield">
    <ul id="friendlist">
      <!-- The list of friends will be displayed here and is created by createFriendlist() -->
    </ul>
  </div>
  <hr>
  <div>
    <h2 class="h2left">New Requests</h2>

    <ol>
      <li>Friend request from <b>Track</b>
        <a href="unknownyet.txt"><button class="regular-button">Accept</button></a>
        <a href="unknownyet.txt"><button class="regular-button">Reject</button></a>
      </li>
    </ol>
  </div>



  <input placeholder="Add Friend to List" name="friendRequestName" id="friend-request-name" list="friend-selector">
  <datalist id="friend-selector"></datalist>
  <button type="button" id="add-friend-button">Add</button>

  <script>
    const TOKEN = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoiVG9tIiwiaWF0IjoxNzMyMDIxNDYwfQ.3g4DxMDq6WiV6GBwUU8Hz1ho4UJfcS0ZfHXlTxHiOH8';

    function getUsers() {
      return new Promise((resolve) => {
        let xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
          if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
            let data = JSON.parse(xmlhttp.responseText);
            resolve(data);
          }
        };
        xmlhttp.open("GET", "https://online-lectures-cs.thi.de/chat/62eb1b2e-d66c-4a9b-b172-5942717d0bac/user", true);
        xmlhttp.setRequestHeader('Authorization', TOKEN);
        xmlhttp.send();
      })

    }

    async function getFriends() {
      return new Promise((resolve) => {
        let xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
          if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
            let data = JSON.parse(xmlhttp.responseText);
            resolve(data);
          }
        };
        xmlhttp.open("GET", "https://online-lectures-cs.thi.de/chat/62eb1b2e-d66c-4a9b-b172-5942717d0bac/friend", true);
        xmlhttp.setRequestHeader('Content-type', 'application/json');
        xmlhttp.setRequestHeader('Authorization', TOKEN);
        xmlhttp.send();
      });
    }

    function postFriends(userName) {
      let xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function () {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 204) {
          console.log("Requested...");
        }
      };
      xmlhttp.open("POST", "https://online-lectures-cs.thi.de/chat/62eb1b2e-d66c-4a9b-b172-5942717d0bac/friend", true);
      xmlhttp.setRequestHeader('Content-type', 'application/json');
      xmlhttp.setRequestHeader('Authorization', TOKEN);
      let data = {
        username: userName
      };
      let jsonString = JSON.stringify(data);
      xmlhttp.send(jsonString);
    }

    function createDatalist(users) {
      const datalist = document.getElementById("friend-selector");
      datalist.innerHTML = ""; // Vorherige Einträge löschen

      users.forEach(user => {
        const option = document.createElement("option");
        option.value = user;
        datalist.appendChild(option);
        // <option value="username"></option>
      });
    }

    function createFriendlist(friends) {
      const friendlist = document.getElementById("friendlist");
      friendlist.innerHTML = ""; // Vorherige Einträge löschen

      friends.forEach(friend => {
        if (friend.status === "accepted") { // Nur akzeptierte Freunde anzeigen
          const li = document.createElement("li");
          const a = document.createElement("a");
          a.href = "chat.html";
          a.textContent = friend.username;
          li.appendChild(a);
          friendlist.appendChild(li);
          // <li>
          //  <a href="chat.html">Tom</a>
          // </li> 
        }
        console.log("friend:", friend);
      });
    }

    function onClickAddFriend(filterUsers) {
      document.getElementById("add-friend-button").addEventListener("click", () => {
        const input = document.getElementById("friend-request-name");
        const friendRequestName = input.value;

        if (friendRequestName === "") {
          alert("Bitte geben Sie einen gültigen Benutzernamen ein.");
          return;
        }

        if (!filterUsers.includes(friendRequestName)) {
          alert("Dieser Benutzer hat bereits eine Freundschaftsanfrage erhalten oder ist bereits Ihr Freund.");
          return;
        }

        postFriends(friendRequestName); // Freund hinzufügen
        alert(`Freundesanfrage an ${friendRequestName} gesendet!`);
      });
    }


    function postFriends(userName) {
      let xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function () {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 204) {
          console.log("Freund hinzugefügt...");
        }
      };
      xmlhttp.open("POST", "https://online-lectures-cs.thi.de/chat/62eb1b2e-d66c-4a9b-b172-5942717d0bac/friend", true);
      xmlhttp.setRequestHeader('Content-type', 'application/json');
      xmlhttp.setRequestHeader('Authorization', TOKEN);
      let data = { username: userName };
      xmlhttp.send(JSON.stringify(data));
    }


    function postFriends(userName) {
      let xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function () {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 204) {
          console.log("Freund hinzugefügt...");
        }
      };
      xmlhttp.open("POST", "https://online-lectures-cs.thi.de/chat/62eb1b2e-d66c-4a9b-b172-5942717d0bac/friend", true);
      xmlhttp.setRequestHeader('Content-type', 'application/json');
      xmlhttp.setRequestHeader('Authorization', TOKEN);
      let data = { username: userName };
      xmlhttp.send(JSON.stringify(data));
    }

    const loggedInUser = "Tom"; // Aktuell eingeloggter Benutzer

    // Hauptlogik
    async function main() {
      try {
        const friends = await getFriends(); // object
        const users = await getUsers();
        const friendUsernames = friends.map(friend => friend.username); //string[]

        const filteredUsers = users.filter(user =>
          user !== loggedInUser // ohne eingeloggten Benutzer
          && !friendUsernames.includes(user) // ohne bereits hinzugefügte/angefragte Freunde
        );

        createFriendlist(friends);
        createDatalist(filteredUsers);
        onClickAddFriend(filteredUsers);


      } catch (error) {
        console.error("Error during initialization:", error);
      }
    }

    // main
    main();
  </script>
  <hr>

</body>

</html>