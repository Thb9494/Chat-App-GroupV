<!DOCTYPE html>
<html>

<head>
  <title>Friend list</title>
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <h1 class="h1left">Friends</h1>
  <div class="navbar">
    <!-- &lt is the sign for the "<" -> span changes the inline styling without 
            changing the representation of the, in this case, link
            &gt stands for ">" -->

    <a href="logout.html"> <span>&lt; Logout</span></a> |

    <!-- The pipe character is seprating the two links -->

    <a href="settings.html"> Settings</a>
  </div>

  <!-- hr is rendering a seperator line -->

  <hr />

  <div class="chatfield">
    <ul>
      <li>
        <a href="chat.html"> Tom </a>
        <div>3</div>
      </li>
      <li>
        <a href="chat.html"> Marvin </a>
        <div>1</div>
      </li>
      <li>
        <a href="chat.html"> Tick</a>
      </li>
      <li>
        <a href="chat.html"> Trick</a>
      </li>
    </ul>
  </div>
  <hr>
  <div>
    <h2 class="h2left">New Requests</h2>

    <ol>
      <li>Friend request from <b>Track</b>
        <a href="unknownyet.txt"><button class="regular-button">Accept</button></a>
        <a href="unknownyet.txt"><button class="regular-button">Reject</button></a>
      </li>
    </ol>
  </div>



  <input placeholder="Add Friend to List" name="friendRequestName" id="friend-request-name" list="friend-selector">
  <datalist id="friend-selector"></datalist>
  <button type="button" id="add-friend-button">Add</button>

  <script>
    const TOKEN = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoiVG9tIiwiaWF0IjoxNzMyMDIxNDYwfQ.3g4DxMDq6WiV6GBwUU8Hz1ho4UJfcS0ZfHXlTxHiOH8';
  
    function getUsers() {
      return new Promise((resolve, reject) => {
        let xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
          if (xmlhttp.readyState == 4) {
            if (xmlhttp.status == 200) {
              resolve(JSON.parse(xmlhttp.responseText));
            } else {
              reject("Failed to fetch users");
            }
          }
        };
        xmlhttp.open("GET", "https://online-lectures-cs.thi.de/chat/62eb1b2e-d66c-4a9b-b172-5942717d0bac/user", true);
        xmlhttp.setRequestHeader('Authorization', TOKEN);
        xmlhttp.send();
      });
    }
  
    function getFriends() {
      return new Promise((resolve, reject) => {
        let xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
          if (xmlhttp.readyState == 4) {
            if (xmlhttp.status == 200) {
              resolve(JSON.parse(xmlhttp.responseText));
            } else {
              reject("Failed to fetch friends");
            }
          }
        };
        xmlhttp.open("GET", "https://online-lectures-cs.thi.de/chat/62eb1b2e-d66c-4a9b-b172-5942717d0bac/friend", true);
        xmlhttp.setRequestHeader('Content-type', 'application/json');
        xmlhttp.setRequestHeader('Authorization', TOKEN);
        xmlhttp.send();
      });
    }
  
    function populateDatalist(users) {
      const datalist = document.getElementById("friend-selector");
      datalist.innerHTML = ""; // Vorherige Einträge löschen
  
      users.forEach(user => {
        const option = document.createElement("option");
        option.value = user;
        datalist.appendChild(option);
      });
    }
  
    function onClickAddFriend(filteredUsers) {
      document.getElementById("add-friend-button").addEventListener("click", () => {
        const input = document.getElementById("friend-request-name");
        const friendRequestName = input.value;
  
        if (!friendRequestName || !filteredUsers.includes(friendRequestName)) {
          alert("Bitte wählen Sie einen gültigen Freund aus der Liste.");
          return;
        }
  
        postFriends(friendRequestName); // Freund hinzufügen
        alert(`Freundesanfrage an ${friendRequestName} gesendet!`);
      });
    }
  
    function postFriends(userName) {
      let xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function () {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 204) {
          console.log("Freund hinzugefügt...");
        }
      };
      xmlhttp.open("POST", "https://online-lectures-cs.thi.de/chat/62eb1b2e-d66c-4a9b-b172-5942717d0bac/friend", true);
      xmlhttp.setRequestHeader('Content-type', 'application/json');
      xmlhttp.setRequestHeader('Authorization', TOKEN);
      let data = { username: userName };
      xmlhttp.send(JSON.stringify(data));
    }
  
    const loggedInUser = "Tom"; // Aktuell eingeloggter Benutzer
  
    // Hauptlogik
    async function initialize() {
      try {
        const [users, friends] = await Promise.all([getUsers(), getFriends()]);
        const friendsList = friends.map(friend => friend.username);

        const filteredUsers = users.filter(user => !friendsList.includes(user) && user !== loggedInUser);
  
        populateDatalist(filteredUsers); // Datalist füllen
        onClickAddFriend(filteredUsers); // Klick-Listener setzen
      } catch (error) {
        console.error("Error during initialization:", error);
      }
    }
  
    // Initialisierung
    initialize();
  </script>
  <hr>

</body>

</html>